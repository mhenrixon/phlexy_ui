# Name of your application. Used to uniquely configure containers.
service: daisyui-docs

# Name of the container image.
image: mhenrixon/daisyui-docs

# Deploy to these servers.
servers:
  web:
    hosts:
      - <%= ENV["DEPLOY_HOST"] %>
    labels:
      traefik.http.routers.daisyui-docs.rule: Host(`<%= ENV["DEPLOY_DOMAIN"] %>`)
      traefik.http.routers.daisyui-docs.entrypoints: websecure
      traefik.http.routers.daisyui-docs.tls.certresolver: letsencrypt
    options:
      network: traefik

# Enable SSL auto certification via Let's Encrypt and target port 443.
proxy:
  ssl: true
  host: <%= ENV["DEPLOY_DOMAIN"] %>

# Credentials for your image host.
registry:
  server: ghcr.io
  username: mhenrixon
  password:
    - KAMAL_REGISTRY_PASSWORD

# Configure builder for multi-arch builds.
builder:
  arch: amd64
  remote: false
  cache:
    type: registry
    options: mode=max,image-manifest=true,oci-mediatypes=true

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  clear:
    RAILS_SERVE_STATIC_FILES: "true"
    RAILS_LOG_TO_STDOUT: "true"
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL

# Persist SQLite database.
volumes:
  - "daisyui_docs_data:/rails/data"

# Configure health check.
healthcheck:
  path: /up
  port: 3000

# Configure boot options.
boot:
  limit: 1
  wait: 30

# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# temporary errors during deploy.
asset_path: /rails/public/assets
